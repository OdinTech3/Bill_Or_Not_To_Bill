---
title: "Model Building"
output: github_document
---

```{r setup, include=F}
knitr::opts_chunk$set(
  fig.path = "markdown_figs/model_building-"
)

load("data/data_preparation.RData")
```

```{r, message=FALSE}
library(keras)
library(dplyr)
library(magrittr)
library(caret)
```

## 1. Spliting Dataset into Training and Validation

```{r echo = F}
set.seed(2019)

train_index <- createDataPartition(
  invoiced,
  p = 0.8,
  list = F,
  times = 1
)
```

### 1.1 Splitting `Call Text` into Training and Validation

```{r}
call_text_train <- call_text_data[train_index,]
call_text_val <- call_text_data[-train_index,]

cat(" Shape of Call Text Train:", dim(call_text_train), "\n",
    "Shape of Call Text Val:", dim(call_text_val))
```

### 1.2 Splitting `Billing Notes` into Training and Validation

```{r}
billing_notes_train <- billing_notes_data[train_index,]
billing_notes_val <- billing_notes_data[-train_index,]

cat(" Shape of Call Text Train:", dim(billing_notes_train), "\n",
    "Shape of Call Text Val:", dim(billing_notes_val))
```

### 1.3 Splitting `Auxilary` Data into Training and Validation

```{r}
auxillaries_train <- auxillaries[train_index,]
auxillaries_val <- auxillaries[-train_index,]

cat(" Shape of Call Text Train:", dim(auxillaries_train), "\n",
    "Shape of Call Text Val:", dim(auxillaries_val))
```

### 1.4 Splitting `Invoiced` into Training and Validation

```{r}
invoiced_train <- invoiced[train_index,]
invoiced_val <- invoiced[-train_index,]

cat(" Shape of Call Text Train:", dim(invoiced_train), "\n",
    "Shape of Call Text Val:", dim(invoiced_val))
```

## 2. Merging Multiple Inputs

### 2.1 Creating The Input Layers

```{r}
call_text_layer <- layer_input(
  shape = c(CONSTANTS$MAX_LEN),
  name = "call_text_layer"
)

billing_notes_layer <- layer_input(
  shape = c(CONSTANTS$MAX_LEN),
  name = "billing_notes_layer"
)

auxiliary_layer <- layer_input(shape = c(dim(auxillaries)[2]), name = 'auxiliary_layer')
```

### 2.2 Creating The Embedding layers

```{r}
call_text_embedding <- call_text_layer %>%
  layer_embedding(
    input_dim = CONSTANTS$MAX_WORDS,
    output_dim = 512,
    input_length = CONSTANTS$MAX_LEN,
    name = "call_text_embedding") %>%
  layer_flatten()


billing_notes_embedding <- billing_notes_layer %>%
  layer_embedding(
    input_dim = CONSTANTS$MAX_WORDS,
    output_dim = 512,
    input_length = CONSTANTS$MAX_LEN,
    name = "billing_notes_embedding") %>%
  layer_flatten()
```

### 2.3 Merging Input and Auxilary Layers

```{r}
main_output <- layer_concatenate(c(call_text_embedding, billing_notes_embedding, auxiliary_layer)) %>%
  layer_dense(units = 64, activation = 'relu') %>%
  layer_dense(units = 64, activation = 'relu') %>%
  layer_dense(units = 64, activation = 'relu') %>%
  layer_dense(units = 1, activation = 'sigmoid', name = 'main_output')
```

### 2.4 Building the Model

```{r}
model <- keras_model(
  inputs = c(call_text_layer, billing_notes_layer, auxiliary_layer),
  outputs = main_output
)
```

```{r}
model %>% compile(
  optimizer = 'rmsprop',
  loss = 'binary_crossentropy'
)

summary(model)
```

```{r}
plot_model(model, show_shapes = T)
```

```{r}
history <- model %>% fit(
  x = list(call_text_train, billing_notes_train, auxillaries_train),
  y = invoiced_train,
  epochs = 10,
  batch_size = 20,
  validation_data = list(list(call_text_val, billing_notes_val, auxillaries_val), invoiced_val)
)
```

```{r}
plot(history)
```
